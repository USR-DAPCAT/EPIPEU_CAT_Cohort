---
title: "Epipeucat cohorte Longitudinal Retospectiva.Evento DFD."
author: "Jordi Real & Rai Puig"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_desti: "dades/mostra"
  ANY: '2018'
---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

## 0. Estado:

**Ventanas de agregaciones**

&check; INCLUSIO.DM2                [ventana.dias=c(-Inf,0)]   <br/>
&check; DG.(problemas de salud)     [ventana.dias=c(-Inf,0)]   <br/>
&check; GRUP365.UEIP                [ventana.dias=c(-365,0)]   <br/>
&check; Deriv2018.                  [ventana.dias=c(-365,0)]   <br/>
&check; FF.(Farmacos)               [ventana.dias=c(-90,0)]    <br/>
&check; Analitiques+Cliniques       [ventana.dias=c(-365,0)]   <br/>
&check; Tabaquisme                  [ventana.dias=c(-Inf,0)]   <br/>
&check; GRUP.UEIPA                  [ventana.dias=c(-Inf,0)]   <br/>


**Ultimas actualizaciones   Febrero/ 2021** 

&check; Agrupadores para amputaciones y revascularizaciones.  <br/>
&check; Solo 2 grupos con ulcera/pie diabetico ( primaria+hospitales) VS .sin ulcera/pie diabetico (primaria+hospitales). <br/>
&check; Nuevas agregaciones de diagnosticos y farmacos. <br/>
&check; Programacion de nuevas recodificaciones. <br/>
&check; Tabla Descriptiva Exploratoria General, por varlidacion.  <br/>
&check; Descriptiva Exploratoria General.Todas las variables.  <br/>
&check; Tabla UEIP:[Ulceras Extremidades Inferiores y/o Pie Diabetico] /UEIPA:[Ulceras Extremidades Inferiores y/o Pie Diabetico y/o Amputaciones] <br/>
&check; Descriptiva Exploratoria General.BASAL.  <br/>
&check; Descriptiva Exploratoria General.Comorbilidades.  <br/>
&check; Descriptiva Exploratoria General.Antecedentes de Pie diabetico.  <br/>
&check; Descriptiva Exploratoria General.Exploracion.  <br/>
&check; Descriptiva Exploratoria General.Laboratorio.  <br/>
&check; Descriptiva Exploratoria General.Tratamiento.  <br/>
&check; Descriptiva Exploratoria General / UEIPA .  <br/> 
 
 
**Realizado**

&check; Lectura / importacion de archivos.  <br/>
&check; Generacion de conductors.   <br/>
&check; Revision de codigos.  <br/>
&check; Agregacion de datos segun protocolo. <br/>
&check; Calculo de varibles y recodificaciones. <br/>
&check; Descriptiva exploratoria. <br/>
&check; Nuevas agregaciones de diagnosticos y farmacos. <br/>
&check; Programacion de nuevas recodificaciones. <br/>
&check; Descriptiva Exploratoria General.Todas las variables.  <br/>
&check; Tabla UEIP:[Ulceras Extremidades Inferiores y/o Pie Diabetico] /UEIPA:[Ulceras Extremidades Inferiores y/o Pie Diabetico y/o Amputaciones] <br/>
&check; Descriptiva Exploratoria General.BASAL.  <br/>
&check; Descriptiva Exploratoria General.Comorbilidades.  <br/>
&check; Descriptiva Exploratoria General.Antecedentes de Pie diabetico.  <br/>
&check; Descriptiva Exploratoria General.Exploracion.  <br/>
&check; Descriptiva Exploratoria General.Laboratorio.  <br/>
&check; Descriptiva Exploratoria General.Tratamiento.  <br/>
&check; Descriptiva Exploratoria General / UEIPA .  <br/> 

**Pendent**

&check; Revision y depuracion de errores.   <br/>
&check; Modelos multivariables.   <br/>



## Fase Preparacio: cataleg+conductor+link_funcions

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")
############
#02.11.2020@
############
#

gc()
# libreries i funcions
library("dplyr")
library("lubridate")
library("compareGroups")


link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

conductor_codis<-here::here("CATALEG_PROYECTO_Manel.xlsx")
conductor<-here::here("conductor_Epipeu.xlsx")




```

```{r llegir, include = FALSE}
# Llegir plana

dades<-readRDS(here::here(params$dir_dades,"dt_plana2.rds")) %>% as_tibble()

```


## Etiquetar_valors_conductor+recodificacions_conductor+missings_conductor+factoritzar.NO.SI
```{r etiquetes}

dades<-dades%>%mutate(exclusio1=ifelse(INCLUSIO.DM2==1,0,1))
dades<-dades%>%mutate(exclusio2=ifelse(age<18,1,0))
dades<-dades%>%mutate(exclusio3=ifelse(dtindex==sortida & situacio!="A",1,0))


dades<-dades%>%mutate(exclusio4=ifelse(DG.ARTPER==1,0,1))
dades<-dades%>%mutate(exclusio5=ifelse(DG.GANGRENA==1,0,1))



dades<-mutate_at(dades, vars( starts_with("exclusio") ), funs( if_else(.==0  | is.na(.)  ,0,1)))

#Recodificar automaticament a partir del Conductor!
dades<-recodificar(dades,taulavariables =conductor,"recode",missings = T)

#Etquetem (Si/No)  a partir del Conductor!
dades<- dades %>% mutate_at(vars(starts_with("DG.")), ~if_else(.==1,"Yes","No",missing = "No")) 
dades<- dades %>% mutate_at(vars(starts_with("EVENT.")), ~if_else(.==1,"Yes","No",missing = "No")) 
dades<- dades %>% mutate_at(vars(starts_with("FF.")), ~if_else(.==1,"Yes","No",missing = "No")) 
dades<- dades %>% mutate_at(vars(starts_with("FP.")), ~if_else(.==1,"Yes","No",missing = "No")) 
#Etquetem (Si/No)  a partir del Conductor!
#dades<-factoritzar.NO.SI(dades,"factor",conductor)

#Etquetem  VALORS! de les VAR  a partir del Conductor!
dades<-etiquetar_valors(dt=dades,variables_factors=conductor,fulla="etiquetes",camp_etiqueta="etiqueta1")


#Apliquem que surtin els MISSINGS a les TAULES , a partir del CONDUCTOR!
dades<-dades%>%mutate_at(extreure.variables("missings",conductor,dt=dades),as.factor)



```

## 1a. Flow chart CONSORT
```{r Flow chart_CONSORT, include=T}


#07.07.2022: 
################################################
#devtools::install_github("tgerke/ggconsort")
################################################

library(ggconsort)
library(dplyr)

head(trial_data)

dat<-trial_data


#################################################
#
#
#
#part 1



study_cohorts <- 
  trial_data %>%
  cohort_start("Assessed for eligibility") %>%
  # Define cohorts using named expressions --------------------
  # Notice that you can use previously defined cohorts in subsequent steps
  
 cohort_define(
    consented = .full %>% filter(declined != 1),
    consented_chemonaive = consented %>% filter(prior_chemo != 1),
    randomized = consented_chemonaive %>% filter(bone_mets != 1),
    treatment_a = randomized %>% filter(treatment == "Drug A"),
    treatment_b = randomized %>% filter(treatment == "Drug B"),
    
    
    # anti_join is useful for counting exclusions -------------
    
    excluded = anti_join(.full, randomized, by = "id"),
    excluded_declined = anti_join(.full, consented, by = "id"),
    excluded_chemo = anti_join(consented, consented_chemonaive, by = "id"),
    excluded_mets = anti_join(consented_chemonaive, randomized, by = "id")
  ) %>%
  
  
  
  # Provide text labels for cohorts ---------------------------
  cohort_label(
    consented = "Consented",
    consented_chemonaive = "Chemotherapy naive",
    randomized = "Randomized",
    treatment_a = "Allocated to arm A",
    treatment_b = "Allocated to arm B",
    excluded = "Excluded",
    excluded_declined = "Declined to participate",
    excluded_chemo = "Prior chemotherapy",
    excluded_mets = "Bone metastasis"
  )



study_cohorts

library(ggplot2)

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, excluded)}<br>
      • {cohort_count_adorn(study_cohorts, excluded_declined)}<br>
      • {cohort_count_adorn(study_cohorts, excluded_chemo)}<br>
      • {cohort_count_adorn(study_cohorts, excluded_mets)}
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts, randomized)
  ) %>%
  consort_box_add(
    "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  ) %>%
  consort_box_add(
    "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  ) %>%
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) %>% 
  consort_arrow_add(
    start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  ) %>%
  consort_line_add(
    start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  ) %>% 
  consort_arrow_add(
    end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  ) %>%
  consort_arrow_add(
    end = "arm_b", end_side = "top", start_x = 30, start_y = 20
  )

#fer-ho més maco!!

study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 8, margin_v = 1) +
  # you can include other ggplot geoms, as needed -------------
  ggtext::geom_richtext(
    aes(x = 0, y = 10, label = "Allocation"),
    fill = "#9bc0fc"
  )

#
#
#
#
#################################################




















#################################################
#
#
#
#part 2


#08.07.2022: 
################################################
#devtools::install_github("tgerke/ggconsort")
################################################

library(ggconsort)
library(dplyr)
library(ggplot2)



K1=c("exclusio1","exclusio2","exclusio3","exclusio4","exclusio5")
LAB=c("A","B","C","D","E")




diagrama_Consort1<-function(dt=dades,TITOL="ll",TRACT="FF.HTA",GRUP2=TRUE)
  {

  TRACT_sym<-sym(TRACT)

#dt=dades
  
study_cohorts <- 
  dt %>%
  cohort_start(POB_LAB[[1]]) %>%
  # Define cohorts using named expressions --------------------
  # [[Definir cohorts utilitzant expressions amb nom]]

  # Notice that you can use previously defined cohorts in subsequent steps
  # [[Tingueu en compte que podeu utilitzar cohorts definides prèviament en passos posteriors]]


  cohort_define(
    exclusio1 = .full %>% filter(exclusio1 != 1),
    treatment_a = exclusio1 %>% filter(!!TRACT_sym == "No"),
    treatment_b = exclusio1 %>% filter(!!TRACT_sym == "Yes"),
    
    
    
  # anti_join is useful for counting exclusions -------------
  # [[anti_join és útil per comptar les exclusions]]  
    exclusio = anti_join(.full,  exclusio1, by = "idp"),
    exclusio1b = anti_join(.full, exclusio1, by = "idp")
   
    
    
    ) %>%
  
  
  # Provide text labels for cohorts ---------------------------
  # [[Proporcioneu etiquetes de text per a les cohorts]] 
  cohort_label(
    exclusio="EXCLUSIONS",
    exclusio1b=EXC_LAB[[1]],
    exclusio1=POB_LAB[[2]],
    treatment_a = "Tratamiento=No",
    treatment_b = "Tratamiento=Si"
      )

#study_cohorts2



study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio1)
  ) %>%
  
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) 
  



if (GRUP2)  {  

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}
      
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio1)
  ) %>%
  consort_box_add(
    "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  ) %>%
  consort_box_add(
    "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  ) %>%
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) %>%
  consort_arrow_add(
    start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  ) %>%
  consort_line_add(
    start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  ) %>% 
  consort_arrow_add(
    end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  ) %>%
  consort_arrow_add(
    end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  


}

 
#fer-ho més maco!!

study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 8, margin_v = 1) +
  # you can include other ggplot geoms, as needed -------------
  ggtext::geom_richtext(
    aes(x = 0, y = 10, label = !!TITOL),
    fill = "#9bc0fc"
  )


#study_consort


#
#
#
#
#################################################


}



diagrama_Consort2<-function(dt=dades,TITOL="kk",TRACT="FF.HTA",GRUP2=TRUE)
  {

TRACT_sym<-sym(TRACT)
  
#dt=dades  
  
study_cohorts <- 
  dt %>%
  cohort_start(POB_LAB[[1]]) %>%
  # Define cohorts using named expressions --------------------
  # [[Definir cohorts utilitzant expressions amb nom]]

  # Notice that you can use previously defined cohorts in subsequent steps
  # [[Tingueu en compte que podeu utilitzar cohorts definides prèviament en passos posteriors]]


  cohort_define(
    exclusio1 = .full %>% filter(exclusio1 != 1),
    exclusio2 =  exclusio1 %>% filter(exclusio2 != 1),
    treatment_a = exclusio2 %>% filter(!!TRACT_sym == "No"),
    treatment_b = exclusio2 %>% filter(!!TRACT_sym == "Yes"),
    
  # anti_join is useful for counting exclusions -------------
  # [[anti_join és útil per comptar les exclusions]]  
    exclusio = anti_join(.full,  exclusio2, by = "idp"),
    exclusio1b = anti_join(.full, exclusio1, by = "idp"),
    exclusio2b = anti_join( exclusio1, exclusio2, by = "idp")
    
    
    
    ) %>%
  
  
  
  
  
  # Provide text labels for cohorts ---------------------------
  # [[Proporcioneu etiquetes de text per a les cohorts]] 
  cohort_label(
    exclusio="EXCLUSIONS",
    exclusio1b=EXC_LAB[[1]],
    exclusio2b=EXC_LAB[[2]],
    exclusio2=POB_LAB[[2]],
    treatment_a = "Tratamiento=No",
    treatment_b = "Tratamiento=Si"

  )

#study_cohorts2



study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)}')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio2)
  ) %>%
  
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) 
  


if (GRUP2)  {  

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)} ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio2)
  ) %>%
  consort_box_add(
    "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  ) %>%
  consort_box_add(
    "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  ) %>%
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) %>%
  consort_arrow_add(
    start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  ) %>%
  consort_line_add(
    start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  ) %>% 
  consort_arrow_add(
    end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  ) %>%
  consort_arrow_add(
    end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  


}

 
#fer-ho més maco!!

study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 8, margin_v = 1) +
  # you can include other ggplot geoms, as needed -------------
  ggtext::geom_richtext(
    aes(x = 0, y = 10, label = !!TITOL),
    fill = "#9bc0fc"
  )


#study_consort



#
#
#
#
#################################################


}


diagrama_Consort3<-function(dt=dades,TITOL="capullo",TRACT="FF.HTA",GRUP2=TRUE)
  {

  
  #dt=dades
  #TITOL="PUTA"
  #TRACT="FF.HTA"
  #GRUP2=FALSE
  
  TRACT_sym<-sym(TRACT)
  
study_cohorts <- 
  dt %>%
  cohort_start(POB_LAB[[1]]) %>%
  # Define cohorts using named expressions --------------------
  # [[Definir cohorts utilitzant expressions amb nom]]

  # Notice that you can use previously defined cohorts in subsequent steps
  # [[Tingueu en compte que podeu utilitzar cohorts definides prèviament en passos posteriors]]#


 
  cohort_define(
    exclusio1 = .full %>% filter(exclusio1 != 1),
    exclusio2 =  exclusio1 %>% filter(exclusio2 != 1),
    exclusio3 =  exclusio2 %>% filter(exclusio3 != 1),
    treatment_a = exclusio3 %>% filter(!!TRACT_sym == "No"),
    treatment_b = exclusio3 %>% filter(!!TRACT_sym == "Yes"),
    
  # anti_join is useful for counting exclusions -------------
  # [[anti_join és útil per comptar les exclusions]]  
    exclusio = anti_join(.full,  exclusio3, by = "idp"),
    exclusio1b = anti_join(.full, exclusio1, by = "idp"),
    exclusio2b = anti_join( exclusio1, exclusio2, by = "idp"),
    exclusio3b = anti_join( exclusio2, exclusio3, by = "idp")
    
    ) %>%
  
  
  
  
  
  # Provide text labels for cohorts ---------------------------
  # [[Proporcioneu etiquetes de text per a les cohorts]] 
  cohort_label(
    exclusio="EXCLUSIONS",
    exclusio1b=EXC_LAB[[1]],
    exclusio2b=EXC_LAB[[2]],
    exclusio3b=EXC_LAB[[3]],
    exclusio3=POB_LAB[[2]],
    treatment_a = "Tratamiento=No",
    treatment_b = "Tratamiento=Si"

  )

#study_cohorts2




study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio3b)}
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio3)
  ) %>%
  #consort_box_add(
  #  "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  #) %>%
  #consort_box_add(
  #  "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  #) %>%
  consort_arrow_add(
     end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) 
  #consort_arrow_add(
  #  start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  #) %>%
  #consort_line_add(
  #  start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  #) %>% 
  #consort_arrow_add(
  #  end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  #) %>%
  #consort_arrow_add(
  #  end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  

  

if (GRUP2)  {  

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio3b)}
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio3)
  ) %>%
  consort_box_add(
    "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  ) %>%
  consort_box_add(
    "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  ) %>%
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) %>%
  consort_arrow_add(
    start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  ) %>%
  consort_line_add(
    start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  ) %>% 
  consort_arrow_add(
    end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  ) %>%
  consort_arrow_add(
    end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  


}

 

#fer-ho més maco!!

study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 8, margin_v = 1) +
  # you can include other ggplot geoms, as needed -------------
  ggtext::geom_richtext(
    aes(x = 0, y = 10, label = !!TITOL),
    fill = "#9bc0fc"
  )


#study_consort

#
#
#
#
#################################################


}






diagrama_Consort4<-function(dt=dades,TITOL="capullo",TRACT="FF.HTA",GRUP2=TRUE)
  {

  
  #dt=dades
  #TITOL="PUTA"
  #TRACT="FF.HTA"
  #GRUP2=FALSE
  
  TRACT_sym<-sym(TRACT)
  
study_cohorts <- 
  dt %>%
  cohort_start(POB_LAB[[1]]) %>%
  # Define cohorts using named expressions --------------------
  # [[Definir cohorts utilitzant expressions amb nom]]

  # Notice that you can use previously defined cohorts in subsequent steps
  # [[Tingueu en compte que podeu utilitzar cohorts definides prèviament en passos posteriors]]#


 
  cohort_define(
    exclusio1 = .full %>% filter(exclusio1 != 1),
    exclusio2 =  exclusio1 %>% filter(exclusio2 != 1),
    exclusio3 =  exclusio2 %>% filter(exclusio3 != 1),
    exclusio4 =  exclusio3 %>% filter(exclusio4 != 1),
    treatment_a = exclusio4 %>% filter(!!TRACT_sym == "No"),
    treatment_b = exclusio4 %>% filter(!!TRACT_sym == "Yes"),
    
  # anti_join is useful for counting exclusions -------------
  # [[anti_join és útil per comptar les exclusions]]  
    exclusio = anti_join(.full,  exclusio3, by = "idp"),
    exclusio1b = anti_join(.full, exclusio1, by = "idp"),
    exclusio2b = anti_join( exclusio1, exclusio2, by = "idp"),
    exclusio3b = anti_join( exclusio2, exclusio3, by = "idp"),
    exclusio4b = anti_join( exclusio3, exclusio4, by = "idp"),
    
    ) %>%
  
  
  
  
  
  # Provide text labels for cohorts ---------------------------
  # [[Proporcioneu etiquetes de text per a les cohorts]] 
  cohort_label(
    exclusio="EXCLUSIONS",
    exclusio1b=EXC_LAB[[1]],
    exclusio2b=EXC_LAB[[2]],
    exclusio3b=EXC_LAB[[3]],
    exclusio4b=EXC_LAB[[4]],
    exclusio4=POB_LAB[[2]],
    treatment_a = "Tratamiento=No",
    treatment_b = "Tratamiento=Si"

  )

#study_cohorts2




study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio3b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio4b)}
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio4)
  ) %>%
  
  #consort_box_add(
  #  "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  #) %>%
  #consort_box_add(
  #  "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  #) %>%
  consort_arrow_add(
     end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) 
  #consort_arrow_add(
  #  start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  #) %>%
  #consort_line_add(
  #  start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  #) %>% 
  #consort_arrow_add(
  #  end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  #) %>%
  #consort_arrow_add(
  #  end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  

if (GRUP2)  {  

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio3b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio4b)}
      
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio4)
  ) %>%
  consort_box_add(
    "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  ) %>%
  consort_box_add(
    "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  ) %>%
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) %>%
  consort_arrow_add(
    start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  ) %>%
  consort_line_add(
    start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  ) %>% 
  consort_arrow_add(
    end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  ) %>%
  consort_arrow_add(
    end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  


}


#fer-ho més maco!!

study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 8, margin_v = 1) +
  # you can include other ggplot geoms, as needed -------------
  ggtext::geom_richtext(
    aes(x = 0, y = 10, label = !!TITOL),
    fill = "#9bc0fc"
  )


#study_consort

#
#
#
#
#################################################


}






diagrama_Consort5<-function(dt=dades,TITOL="capullo",TRACT="FF.HTA",GRUP2=TRUE)
  {

  
  #dt=dades
  #TITOL="PUTA"
  #TRACT="FF.HTA"
  #GRUP2=FALSE
  
  TRACT_sym<-sym(TRACT)
  
study_cohorts <- 
  dt %>%
  cohort_start(POB_LAB[[1]]) %>%
  # Define cohorts using named expressions --------------------
  # [[Definir cohorts utilitzant expressions amb nom]]

  # Notice that you can use previously defined cohorts in subsequent steps
  # [[Tingueu en compte que podeu utilitzar cohorts definides prèviament en passos posteriors]]#


 
  cohort_define(
    exclusio1 = .full %>% filter(exclusio1 != 1),
    exclusio2 =  exclusio1 %>% filter(exclusio2 != 1),
    exclusio3 =  exclusio2 %>% filter(exclusio3 != 1),
    exclusio4 =  exclusio3 %>% filter(exclusio4 != 1),
    exclusio5 =  exclusio4 %>% filter(exclusio5 != 1),
    treatment_a = exclusio4 %>% filter(!!TRACT_sym == "No"),
    treatment_b = exclusio4 %>% filter(!!TRACT_sym == "Yes"),
    
  # anti_join is useful for counting exclusions -------------
  # [[anti_join és útil per comptar les exclusions]]  
    exclusio = anti_join(.full,  exclusio3, by = "idp"),
    exclusio1b = anti_join(.full, exclusio1, by = "idp"),
    exclusio2b = anti_join( exclusio1, exclusio2, by = "idp"),
    exclusio3b = anti_join( exclusio2, exclusio3, by = "idp"),
    exclusio4b = anti_join( exclusio3, exclusio4, by = "idp"),
    exclusio5b = anti_join( exclusio4, exclusio5, by = "idp")
    ) %>%
  
  
  
  
  
  # Provide text labels for cohorts ---------------------------
  # [[Proporcioneu etiquetes de text per a les cohorts]] 
  cohort_label(
    exclusio="EXCLUSIONS",
    exclusio1b=EXC_LAB[[1]],
    exclusio2b=EXC_LAB[[2]],
    exclusio3b=EXC_LAB[[3]],
    exclusio4b=EXC_LAB[[4]],
    exclusio5b=EXC_LAB[[5]],
    exclusio5=POB_LAB[[2]],
    treatment_a = "Tratamiento=No",
    treatment_b = "Tratamiento=Si"

  )

#study_cohorts2




study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio3b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio4b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio5b)}
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio5)
  ) %>%
  
  #consort_box_add(
  #  "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  #) %>%
  #consort_box_add(
  #  "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  #) %>%
  consort_arrow_add(
     end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) 
  #consort_arrow_add(
  #  start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  #) %>%
  #consort_line_add(
  #  start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  #) %>% 
  #consort_arrow_add(
  #  end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  #) %>%
  #consort_arrow_add(
  #  end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  



 
  

if (GRUP2)  {  

study_consort <- study_cohorts %>%
  consort_box_add(
    "full", 0, 50, cohort_count_adorn(study_cohorts, .full)
  ) %>%
  consort_box_add(
    "exclusions", 20, 40, glue::glue(
      '{cohort_count_adorn(study_cohorts, exclusio)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio1b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio2b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio3b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio4b)}<br>
      • {cohort_count_adorn(study_cohorts, exclusio5b)}
      ')
  ) %>%
  consort_box_add(
    "randomized", 0, 30, cohort_count_adorn(study_cohorts,exclusio5)
  ) %>%
  consort_box_add(
    "arm_a", -30, 10, cohort_count_adorn(study_cohorts, treatment_a)
  ) %>%
  consort_box_add(
    "arm_b", 30, 10, cohort_count_adorn(study_cohorts, treatment_b)
  ) %>%
  consort_arrow_add(
    end = "exclusions", end_side = "left", start_x = 0, start_y = 40
  ) %>%
  consort_arrow_add(
    "full", "bottom", "randomized", "top"
  ) %>%
  consort_arrow_add(
    start_x = 0, start_y = 30, end_x = 0, end_y = 20,
  ) %>%
  consort_line_add(
    start_x = -30, start_y = 20, end_x = 30, end_y = 20,
  ) %>% 
  consort_arrow_add(
    end = "arm_a", end_side = "top", start_x = -30, start_y = 20
  ) %>%
  consort_arrow_add(
    end = "arm_b", end_side = "top", start_x = 30, start_y = 20)
  


}

#fer-ho més maco!!

study_consort %>%
  ggplot() + 
  geom_consort() +
  theme_consort(margin_h = 8, margin_v = 1) +
  # you can include other ggplot geoms, as needed -------------
  ggtext::geom_richtext(
    aes(x = 0, y = 10, label = !!TITOL),
    fill = "#9bc0fc"
  )


#study_consort

#
#
#
#
#################################################


}



diagrama_Consort<-function(dt=dades,EXCLUSIONS=K1,TITOL="LALA",TRACT="FF.HTA",GRUP2=FALSE)
  
  {

  K2=(EXCLUSIONS%in%colnames(dt))
  nEXC=length(K2[K2== TRUE])

 if ( nEXC==1) {diagrama_Consort1(dt=dades,TITOL=TITOL,TRACT=TRACT,GRUP2=GRUP2)}
 else if ( nEXC==2) {diagrama_Consort2(dt=dades,TITOL=TITOL,TRACT=TRACT,GRUP2=GRUP2)}
 else if ( nEXC==3) {diagrama_Consort3(dt=dades,TITOL=TITOL,TRACT=TRACT,GRUP2=GRUP2)}
 else if ( nEXC==4) {diagrama_Consort4(dt=dades,TITOL=TITOL,TRACT=TRACT,GRUP2=GRUP2)}
 else if ( nEXC==5) {diagrama_Consort5(dt=dades,TITOL=TITOL,TRACT=TRACT,GRUP2=GRUP2)}  
 else if ( nEXC>5 ) {print("Flow-chart menys de 6 Exclusions")}
 else if  (  nEXC==0 )  {print("Possible Error, NO HI HA EXCLUSIONS!")}
  
  

  }



POB_LAB=c("epiPEUCAT DM2","epiPEUCAT DM2 SIN EXCLUS")
EXC=c("exclusio1")
EXC_LAB=c("A")
P1a<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL="HOLA COCA-COLA 1 exclusio",TRACT="FF.HTA",GRUP2=FALSE)
P1b<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL="HOLA COCA-COLA 1 exclusio",TRACT="FF.HTA",GRUP2=TRUE)



EXC=c("exclusio1","exclusio2")
EXC_LAB=c("A","B")
P2a<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL="HOLA COLA-CAU 2 exclusions",TRACT="FF.HTA",GRUP2=FALSE)
P2b<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL="HOLA COLA-CAU 2 exclusions",TRACT="FF.HTA",GRUP2=TRUE)


EXC=c("exclusio1","exclusio2","exclusio3")
EXC_LAB=c("A","B","C")
P3a<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL = "ADEU COCA-COLA 3 exclusions",TRACT="FF.HTA",GRUP2=FALSE)
P3b<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL = "ADEU COCA-COLA 3 exclusions",TRACT="FF.HTA",GRUP2=TRUE)



EXC=c("exclusio1","exclusio2","exclusio3","exclusio4")
EXC_LAB=c("A","B","C","D")
P4a<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL = "ADEU COLA-CAU 4 exclusions",TRACT="FF.HTA",GRUP2=FALSE)
P4b<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL = "ADEU COLA-CAU 4 exclusions",TRACT="FF.HTA",GRUP2=TRUE)

EXC=c("exclusio1","exclusio2","exclusio3","exclusio4","exclusio5")
EXC_LAB=c("A","B","C","D","E")
P5a<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL = "HOLA HOLA 5 exclusions",TRACT="FF.HTA",GRUP2=FALSE)
P5b<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC,TITOL = "ADEU ADEU 5 exclusions",TRACT="FF.HTA",GRUP2=TRUE)

EXC=c("exclusio7")
EXC_LAB=c("A","B","C","D","E")
P6<-diagrama_Consort(dt=dades,EXCLUSIONS=EXC)





P1a
P1b

P2a
P2b

P3a
P3b

P4a
P4b

P5a
P5b

P6








```
## 1b. Flow chart + Etiquetar_Nom_Variables_conductor
```{r Flow chart, include=T}

#13.11.2020

#

flow_chart1<-criteris_exclusio_diagrama(dt=dades,
                                        taulavariables=conductor,
                                        criteris = "exc_pre",
                                        ordre="exc_ordre",
                                        grups=NA,
                                        etiquetes="descripcio",
                                        sequencial = T,
                                        pob_lab=c("epiPEUCAT DM2  ","epiPEUCAT DM2 sin exclusiones"),
                                        colors=c("white","grey"),
                                        forma=c("ellipse","box"))

flow_chart1




#Apliquem les EXCLUSIONS!
dades<-criteris_exclusio(dades,taulavariables=conductor,criteris="exc_pre")


#Etquetem  NOMS! de les  VAR  a partir del Conductor!
dades<-etiquetar(dades,taulavariables=conductor)




```

## 2. Descriptiva Exploratoria General. Todas las variables.


```{r resultats1, include=T}


descrTable(~., dades,method = 2,Q1=0,Q3=1,extra.labels = c("","","")) %>% export2md()



```





```

&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



